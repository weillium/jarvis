---
alwaysApply: true
---

# Project Rules

## scope
- Work within `/worker`, `/web`, `/supabase`, `/mobile`, `/packages`, and `/dev_docs` only.
- Preserve existing in-progress changes; do not revert without explicit approval.
- Confirm assumptions before aggressive refactors while we’re inside the active wave.

## worker
- lint output is advisory guidance (until worker state machine refactor is complete).
- DTO-first for all IO boundaries (Supabase / OpenAI / WebSocket).
- `any` forbidden in worker; use `unknown` with runtime guards instead.
- never inline `JSON.parse` directly → wrap with shared safe parse helpers.
- caught errors log as `String(err)` only → do not read `.message`, `.stack`, etc.
- normalization utilities → consolidate under `worker/lib/**`.
- maintain the separation between the **cards** realtime agent, the **transcripts** realtime agent, and the **facts** stateless agent.

## web
- React Query is the *only* source of server state.
- prefer **query / mutation hooks** instead of custom fetch + useState.
- use absolute imports `@/*` in web code.
- **use Tamagui components from `@jarvis/ui-core`** for all UI work; TailwindCSS and Material-UI are removed.
- import shared primitives: `Button`, `Input`, `Textarea`, `Card`, `Alert`, `YStack`, `XStack`, `Text`, `Sheet` from `@jarvis/ui-core`.
- use Tamagui tokens (`$color`, `$gray11`, `$blue6`, etc.) and spacing (`$4`, `$6`, etc.) for styling.

## mobile
- Expo + React Native app; keep platform-specific code inside `/mobile`.
- use React Query as the single source of server state here as well.
- **use Tamagui components from `@jarvis/ui-core`** for all UI work; same shared components as web.
- import shared primitives: `Button`, `Input`, `Textarea`, `Card`, `Alert`, `YStack`, `XStack`, `Text`, `Sheet` from `@jarvis/ui-core`.
- `TamaguiProvider` is already set up in `mobile/app/_layout.tsx`.

## packages
- `packages/ui-core` hosts shared Tamagui components and configuration consumed by both `/web` and `/mobile`.
- ensure exports remain platform-agnostic (Tamagui primitives, universal hooks, or pure logic).
- Tamagui config lives in `packages/ui-core/src/tamagui.config.ts`; theme tokens defined there.
- base components: `Button`, `Input`, `Textarea`, `Card`, `Alert` in `packages/ui-core/src/components/`.
- if platform-specific variants are required, gate them behind explicit sub-entries (e.g., `packages/ui-core/web` vs `packages/ui-core/native`).

## supabase
- every DB change is done via: `supabase migration new <name>`
- every DB change implementation is done via: `supabase migration up`
- pair every migration with required **indexes** and **RLS** policies.

## docs
- docs live under `/dev_docs/`
- filename pattern: `YYYYMMDD_HHMMSS_*`

---

### Command Reference

These are the official repository-wide commands. All are allowed:

- `split_module`
- `harden_types`
- `add_dto_boundaries`
- `normalize_utils`
- `new_migration`
- `apply_indexes`
- `create_query_hook`
- `replace_fetch`
