---
alwaysApply: true
---

# Project Rules

## scope
- Work within `/worker`, `/web`, `/supabase`, and `/dev_docs` only.
- Preserve existing in-progress changes; do not revert without explicit approval.
- Confirm assumptions before aggressive refactors while we’re inside the active wave.

## worker
- lint output is advisory guidance (until worker state machine refactor is complete).
- DTO-first for all IO boundaries (Supabase / OpenAI / WebSocket).
- `any` forbidden in worker; use `unknown` with runtime guards instead.
- never inline `JSON.parse` directly → wrap with shared safe parse helpers.
- caught errors log as `String(err)` only → do not read `.message`, `.stack`, etc.
- normalization utilities → consolidate under `worker/lib/**`.
- maintain the separation between the **cards** realtime agent, the **transcripts** realtime agent, and the **facts** stateless agent.
- the following files are protected (no edits unless explicitly told):
  - `worker/context/pipeline/context-generation-orchestrator.ts`
  - `worker/context/pipeline/orchestrator/exa-orchestrator.ts`
  - `worker/context/pipeline/orchestrator/supabase-orchestrator.ts`
  - `worker/context/pipeline/orchestrator/llm-orchestrator.ts`
  - `worker/sessions/realtime-session.ts`

## web
- React Query is the *only* source of server state.
- prefer **query / mutation hooks** instead of custom fetch + useState.
- use absolute imports `@/*` in web code.

## supabase
- every DB change is done via: `supabase migration new <name>`
- pair every migration with required **indexes** and **RLS** policies.

## docs
- docs live under `/dev_docs/`
- filename pattern: `YYYYMMDD_HHMMSS_*`

---

### Command Reference

These are the official repository-wide commands. All are allowed:

- `split_module`
- `harden_types`
- `add_dto_boundaries`
- `normalize_utils`
- `new_migration`
- `apply_indexes`
- `create_query_hook`
- `replace_fetch`
